<app-navbar />

<div class="container py-4">
  <h2 class="fw-bold mb-4">
    {{ mode() === "create" ? "Create New Course" : "Edit Course" }}
  </h2>

  @if (error()) {
    <div class="alert alert-danger">{{ error() }}</div>
  }

  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <form [formGroup]="courseForm" (ngSubmit)="onSubmit()">
        <!-- Title -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Course Title</label>
          <input
            type="text"
            class="form-control"
            formControlName="title"
            placeholder="Enter course title"
          />
          @if (courseForm.get('title')?.touched && courseForm.get('title')?.invalid) {
            <div class="text-danger small mt-1">Title is required.</div>
          }
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Description</label>
          <textarea
            rows="4"
            class="form-control"
            formControlName="description"
            placeholder="Enter course description"
          ></textarea>
          @if (courseForm.get('description')?.touched && courseForm.get('description')?.invalid) {
            <div class="text-danger small mt-1">Description is required.</div>
          }
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Category</label>
          <input
            type="text"
            class="form-control"
            formControlName="category"
            placeholder="e.g. Programming"
          />
          @if (courseForm.get('category')?.touched && courseForm.get('category')?.invalid) {
            <div class="text-danger small mt-1">Category is required.</div>
          }
        </div>

        <!-- Image Url -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Image URL</label>
          <input
            type="url"
            class="form-control"
            formControlName="imageUrl"
            placeholder="https://example.com/image.jpg"
          />
          @if (courseForm.get('imageUrl')?.touched && courseForm.get('imageUrl')?.errors?.['required']) {
            <div class="text-danger small mt-1">Image URL is required.</div>
          }
          @if (courseForm.get('imageUrl')?.touched && courseForm.get('imageUrl')?.errors?.['pattern']) {
            <div class="text-danger small mt-1">Please enter a valid URL.</div>
          }
        </div>

        <!-- Hidden/readonly instructorId (kept in form for DTO completeness) -->
        <input type="hidden" formControlName="instructorId" />

        <div class="d-flex justify-content-end pt-3">
          <a routerLink="/instructor" class="btn btn-outline-secondary me-2">
            Cancel
          </a>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="courseForm.invalid || isSavingCourse()"
          >
            {{ mode() === "create" ? "Create Course" : "Update Course" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Lessons Section: sadece edit modunda ve courseId varsa -->
  @if (mode() === "edit" && courseId()) {
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h4 class="mb-0">Manage Lessons</h4>
      </div>
      <div class="card-body">
        <!-- Ders listesi -->
        @if (lessons().length > 0) {
          <div class="mb-4">
            @for (lesson of lessons(); track lesson.id) {
              <div class="card mb-2">
                <div class="card-body py-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                      <h6 class="card-title mb-1">{{ lesson.title }}</h6>
                      <p class="card-text text-muted small mb-0">
                        Duration: {{ lesson.duration }} |
                        <a
                          [href]="lesson.videoUrl"
                          target="_blank"
                          class="text-decoration-none"
                        >
                          <i class="bi bi-play-btn me-1"></i>Video Link
                        </a>
                      </p>
                    </div>
                    <div class="d-flex">
                      <button
                        class="btn btn-sm btn-outline-primary me-2"
                        (click)="editLesson(lesson)"
                        [disabled]="isUpdatingLesson() || deletingLessonId() === lesson.id"
                      >
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button
                        class="btn btn-sm btn-outline-danger"
                        (click)="deleteLesson(lesson.id)"
                        [disabled]="isUpdatingLesson() || deletingLessonId() === lesson.id"
                      >
                        <i class="bi bi-trash"></i>
                        @if (deletingLessonId() === lesson.id) { Deleting... } @else { Delete }
                      </button>
                    </div>
                  </div>

                  <!-- Edit Lesson formu: sadece bu ders i√ßin a√ßƒ±ksa g√∂ster -->
                  @if (editingLessonId() === lesson.id) {
                    <div class="card p-3 mt-3">
                      <h5 class="mb-3">Edit Lesson</h5>
                      <form [formGroup]="lessonEditForm" (ngSubmit)="saveLesson()" class="row g-3">
                        <div class="col-md-4">
                          <input
                            class="form-control form-control-sm"
                            type="text"
                            formControlName="title"
                            placeholder="Title"
                          />
                        </div>
                        <div class="col-md-4">
                          <input
                            class="form-control form-control-sm"
                            type="url"
                            formControlName="videoUrl"
                            placeholder="https://example.com/video.mp4"
                          />
                        </div>
                        <div class="col-md-2">
                          <input
                            class="form-control form-control-sm"
                            type="text"
                            formControlName="duration"
                            placeholder="10:30"
                          />
                        </div>
                        <div class="col-md-2 d-grid">
                          <button
                            type="submit"
                            class="btn btn-primary btn-sm"
                            [disabled]="lessonEditForm.invalid || isUpdatingLesson()"
                          >
                            üíæ Save
                          </button>
                          <button
                            type="button"
                            class="btn btn-secondary btn-sm mt-2"
                            (click)="cancelEditLesson()"
                            [disabled]="isUpdatingLesson()"
                          >
                            Cancel
                          </button>
                        </div>
                      </form>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-4 text-muted">
            <i class="bi bi-film display-6 d-block mb-2"></i>
            <p>No lessons added yet</p>
          </div>
        }

        <!-- Yeni Lesson Ekle -->
        <h5 class="border-bottom pb-2 mb-3">Add New Lesson</h5>
        <form [formGroup]="lessonCreateForm" (ngSubmit)="addLesson()" class="row g-3">
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Title</label>
            <input
              class="form-control form-control-sm"
              type="text"
              placeholder="Lesson title"
              formControlName="title"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Video URL</label>
            <input
              class="form-control form-control-sm"
              type="url"
              placeholder="https://example.com/video.mp4"
              formControlName="videoUrl"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Duration</label>
            <input
              class="form-control form-control-sm"
              type="text"
              placeholder="10:30"
              formControlName="duration"
            />
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button
              type="submit"
              class="btn btn-success btn-sm w-100"
              [disabled]="lessonCreateForm.invalid || isCreatingLesson()"
            >
              @if (isCreatingLesson()) { Adding... } @else { Add }
            </button>
          </div>
        </form>
      </div>
    </div>
  } @else {
    <div class="alert alert-info mt-3">
      Ders ekleyip y√∂netmek i√ßin √∂nce kursu olu≈üturun (kaydedin). Kurs olu≈üturulduktan sonra ders ekleme b√∂l√ºm√º aktif olacaktƒ±r.
    </div>
  }
</div>