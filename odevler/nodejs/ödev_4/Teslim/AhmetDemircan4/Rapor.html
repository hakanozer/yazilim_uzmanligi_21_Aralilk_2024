<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node.js Arama Fonksiyonu Debug Raporu</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 5px;
        }
        h3 {
            color: #2980b9;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            position: relative;
        }
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 5px;
            right: 10px;
            background: #4a5568;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            color: #a0aec0;
        }
        .error-highlight {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success-highlight {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .old-code {
            background: #fff5f5;
        }
        .new-code {
            background: #f0fff4;
        }
        .lesson-box {
            background: #e6f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .step {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            counter-increment: step-counter;
        }
        .step::before {
            content: "AdÄ±m " counter(step-counter) ": ";
            font-weight: bold;
            color: #495057;
        }
        body {
            counter-reset: step-counter;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Node.js Arama Fonksiyonu Debug Raporu</h1>
        
        <div class="warning">
            <strong>Sorun Ã–zeti:</strong> MongoDB arama fonksiyonu "de" sorgusu ile "Deneme" ve "dene" iÃ§eren notlarÄ± bulamÄ±yor.
        </div>

        <h2>1. ğŸš« Eski HatalÄ± Kod (Orijinal Versiyon)</h2>
        
        <h3>noteService.ts - searchNotes Fonksiyonu</h3>
        <div class="code-block" data-lang="TypeScript">
export const searchNotes = async (req: Request, query: string) => {
    try {
        const notes = await NoteDB.find({
            userID: req.session.item._id,
            $or: [
                { title: { $regex: query, $options: 'i' } },
                { detail: { $regex: query, $options: 'i' } }
            ]
        }).sort({ });
        console.log("ThatQuey:", query);
        return notes;
    } catch (error) {
        return null;
    }
};
        </div>

        <h3>dashboardController.ts - Search Route</h3>
        <div class="code-block" data-lang="TypeScript">
dashboardController.get('/search', async (req, res) => {
    const search = await searchNotes(req, req.query.q as string)  // âœ… Arama yapÄ±yor
    const query = req.query.q as string
    if (!query || query.trim() === '') {
        console.log("Empty search query.");
        return res.redirect('/dashboard'); 
    } else {
        console.log("Search query:", query);
        // Implement search logic here
        // For now, just redirecting to dashboard
        return res.render('dashboard', {search: query}); // âŒ HATA: SonuÃ§larÄ± deÄŸil, query'yi gÃ¶nderiyor
    }
})
        </div>

        <div class="error-highlight">
            <strong>Kritik Hata:</strong> Controller'da arama sonuÃ§larÄ± (<code>search</code> deÄŸiÅŸkeni) hesaplanÄ±yor ama frontend'e gÃ¶nderilmiyor. Bunun yerine sadece arama terimi (<code>query</code>) gÃ¶nderiliyor.
        </div>

        <h2>2. âœ… DÃ¼zeltilmiÅŸ Yeni Kod (Revize EdilmiÅŸ Versiyon)</h2>

        <h3>noteService.ts - Ä°yileÅŸtirilmiÅŸ searchNotes</h3>
        <div class="code-block" data-lang="TypeScript">
import { RegexControll } from "../utils/Regex";

export const searchNotes = async (req: Request, query: string) => {
    try {
        // Session kontrolÃ¼
        if (!req.session?.item?._id) {
            return { error: "User not authenticated" };
        }

        // Regex gÃ¼venlik kontrolÃ¼
        if (!RegexControll(query)) {
            return { error: "Invalid search query" };
        }

        console.log("=== DEBUG START ===");
        console.log("User ID:", req.session.item._id);
        console.log("Query:", query);
        
        const notes = await NoteDB.find({
            userID: req.session.item._id,
            $or: [
                { title: { $regex: query, $options: 'i' } },
                { detail: { $regex: query, $options: 'i' } }
            ]
        }).sort({ title: 1 }); // DÃ¼zgÃ¼n sÄ±ralama
        
        console.log("Search results:", notes.length);
        console.log("=== DEBUG END ===");
        return notes;
    } catch (error) {
        console.error("Search error:", error);
        return { error: "Search failed", details: error.message };
    }
};
        </div>

        <h3>dashboardController.ts - DÃ¼zeltilmiÅŸ Search Route</h3>
        <div class="code-block" data-lang="TypeScript">
dashboardController.get('/search', async (req, res) => {
    const query = req.query.q as string;
    
    if (!query || query.trim() === '') {
        console.log("Empty search query.");
        return res.redirect('/dashboard'); 
    }
    
    // Regex kontrolÃ¼
    if (!RegexControll(query)) {
        console.log("Invalid search query:", query);
        return res.redirect('/dashboard');
    }
    
    console.log("Search query:", query);
    
    // Arama yap ve sonuÃ§larÄ± al
    const searchResults = await searchNotes(req, query);
    
    // SonuÃ§larÄ± frontend'e gÃ¶nder
    return res.render('dashboard', {
        search: query,                    // Arama terimi
        searchResults: searchResults,     // Arama sonuÃ§larÄ± âœ…
        isSearching: true                 // Arama yapÄ±ldÄ±ÄŸÄ±nÄ± belirtmek iÃ§in
    });
})
        </div>

        <h3>utils/Regex.ts - GÃ¼venlik KontrolÃ¼</h3>
        <div class="code-block" data-lang="TypeScript">
export const RegexControll = (query: string) => {
    // BoÅŸ veya sadece boÅŸluk kontrolÃ¼
    if (!query || query.trim().length === 0) {
        return false;
    }
    
    // Minimum uzunluk kontrolÃ¼
    if (query.trim().length < 2) {
        return false;
    }
    
    // GÃ¼venli karakterler (TÃ¼rkÃ§e dahil)
    const regex = /^[a-zA-ZÃ§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÄ°Ã–ÅÃœ0-9\s.,!?-]+$/;
    return regex.test(query);
}
        </div>

        <h2>3. ğŸ”„ KodlarÄ± KÄ±yaslayarak Analiz</h2>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Ã–zellik</th>
                    <th class="old-code">Eski Kod</th>
                    <th class="new-code">Yeni Kod</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Arama SonuÃ§larÄ±</strong></td>
                    <td class="old-code">HesaplanÄ±yor ama kullanÄ±lmÄ±yor</td>
                    <td class="new-code">HesaplanÄ±yor ve frontend'e gÃ¶nderiliyor</td>
                </tr>
                <tr>
                    <td><strong>GÃ¼venlik</strong></td>
                    <td class="old-code">Regex kontrolÃ¼ yok</td>
                    <td class="new-code">RegexControll ile gÃ¼venlik saÄŸlanÄ±yor</td>
                </tr>
                <tr>
                    <td><strong>Session KontrolÃ¼</strong></td>
                    <td class="old-code">Kontrol edilmiyor</td>
                    <td class="new-code">Session varlÄ±ÄŸÄ± kontrol ediliyor</td>
                </tr>
                <tr>
                    <td><strong>Hata YÃ¶netimi</strong></td>
                    <td class="old-code">Sadece null dÃ¶ndÃ¼rÃ¼yor</td>
                    <td class="new-code">DetaylÄ± hata mesajlarÄ±</td>
                </tr>
                <tr>
                    <td><strong>SÄ±ralama</strong></td>
                    <td class="old-code">BoÅŸ sort objesi</td>
                    <td class="new-code">Title'a gÃ¶re alfabetik sÄ±ralama</td>
                </tr>
                <tr>
                    <td><strong>Debug</strong></td>
                    <td class="old-code">Minimal log</td>
                    <td class="new-code">KapsamlÄ± debug loglarÄ±</td>
                </tr>
            </tbody>
        </table>

        <h2>4. ğŸ› HatanÄ±n DetaylÄ± AÃ§Ä±klamasÄ±</h2>

        <div class="step">
            <strong>Ana Sorun:</strong> Controller'da arama fonksiyonu Ã§aÄŸrÄ±lÄ±yor ama sonuÃ§larÄ± frontend'e gÃ¶nderilmiyor.
        </div>

        <div class="step">
            <strong>Veri AkÄ±ÅŸÄ± HatasÄ±:</strong> 
            <code>const search = await searchNotes(...)</code> ile sonuÃ§lar alÄ±nÄ±yor ama 
            <code>res.render('dashboard', {search: query})</code> ile sadece query string'i gÃ¶nderiliyor.
        </div>

        <div class="step">
            <strong>Frontend Beklentisi:</strong> Dashboard.ejs dosyasÄ± arama sonuÃ§larÄ±nÄ± bekliyor ama almÄ±yor, bu yÃ¼zden boÅŸ tablo gÃ¶steriyor.
        </div>

        <div class="step">
            <strong>GÃ¼venlik AÃ§Ä±ÄŸÄ±:</strong> KullanÄ±cÄ± girdisi doÄŸrudan MongoDB regex'ine gÃ¶nderiliyor, bu NoSQL injection riski oluÅŸturuyor.
        </div>

        <h2>5. ğŸ”§ Kodun Neden ve NasÄ±l DeÄŸiÅŸtirildiÄŸi</h2>

        <h3>Controller DeÄŸiÅŸiklikleri:</h3>
        <div class="success-highlight">
            <strong>DeÄŸiÅŸiklik 1:</strong> Arama sonuÃ§larÄ± artÄ±k <code>searchResults</code> olarak frontend'e gÃ¶nderiliyor.<br>
            <strong>Neden:</strong> Frontend'in arama sonuÃ§larÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebilmesi iÃ§in gerekli.
        </div>

        <div class="success-highlight">
            <strong>DeÄŸiÅŸiklik 2:</strong> <code>isSearching: true</code> flag'i eklendi.<br>
            <strong>Neden:</strong> Frontend'in normal notlar ile arama sonuÃ§larÄ± arasÄ±nda ayrÄ±m yapabilmesi iÃ§in.
        </div>

        <h3>Service DeÄŸiÅŸiklikleri:</h3>
        <div class="success-highlight">
            <strong>DeÄŸiÅŸiklik 3:</strong> RegexControll ile gÃ¼venlik kontrolÃ¼ eklendi.<br>
            <strong>Neden:</strong> ZararlÄ± regex pattern'lerini engellemek ve NoSQL injection'Ä± Ã¶nlemek iÃ§in.
        </div>

        <div class="success-highlight">
            <strong>DeÄŸiÅŸiklik 4:</strong> Session kontrolÃ¼ eklendi.<br>
            <strong>Neden:</strong> Kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ kullanÄ±cÄ±larÄ±n arama yapmasÄ±nÄ± engellemek iÃ§in.
        </div>

        <div class="success-highlight">
            <strong>DeÄŸiÅŸiklik 5:</strong> KapsamlÄ± hata yÃ¶netimi eklendi.<br>
            <strong>Neden:</strong> Debug sÃ¼recini kolaylaÅŸtÄ±rmak ve kullanÄ±cÄ±ya anlamlÄ± hata mesajlarÄ± vermek iÃ§in.
        </div>

        <h2>6. ğŸ“š Bu Deneyimden Ã‡Ä±karÄ±lan Dersler</h2>

        <div class="lesson-box">
            <h3>ğŸ¯ Teknik Dersler:</h3>
            <ul>
                <li><strong>Veri AkÄ±ÅŸÄ± Takibi:</strong> Backend'den frontend'e veri akÄ±ÅŸÄ±nÄ± dikkatli takip etmek kritik</li>
                <li><strong>Debug Stratejisi:</strong> Console.log'lar ile veri akÄ±ÅŸÄ±nÄ± adÄ±m adÄ±m takip etmek etkili</li>
                <li><strong>GÃ¼venlik Ã–nceliÄŸi:</strong> KullanÄ±cÄ± girdilerini her zaman validate etmek gerekli</li>
                <li><strong>Hata YÃ¶netimi:</strong> AnlamlÄ± hata mesajlarÄ± debug sÃ¼recini hÄ±zlandÄ±rÄ±r</li>
            </ul>
        </div>

        <div class="lesson-box">
            <h3>ğŸ§  Ã–ÄŸrenim SÃ¼reci KatkÄ±larÄ±:</h3>
            <ul>
                <li><strong>Sistematik YaklaÅŸÄ±m:</strong> Sorunu parÃ§alara bÃ¶lerek analiz etme becerisi geliÅŸti</li>
                <li><strong>Full-Stack AnlayÄ±ÅŸÄ±:</strong> Frontend-Backend entegrasyonunun Ã¶nemi anlaÅŸÄ±ldÄ±</li>
                <li><strong>Code Review AlÄ±ÅŸkanlÄ±ÄŸÄ±:</strong> Kodu yazdÄ±ktan sonra veri akÄ±ÅŸÄ±nÄ± kontrol etme alÄ±ÅŸkanlÄ±ÄŸÄ±</li>
                <li><strong>GÃ¼venlik Bilinci:</strong> Her kullanÄ±cÄ± girdisinin potansiyel risk olduÄŸu kavrandÄ±</li>
            </ul>
        </div>

        <div class="lesson-box">
            <h3>ğŸš€ Gelecek Ä°Ã§in Ã–neriler:</h3>
            <ul>
                <li>Her fonksiyon iÃ§in unit test yazma alÄ±ÅŸkanlÄ±ÄŸÄ± edinmek</li>
                <li>TypeScript tip kontrollerini daha etkin kullanmak</li>
                <li>API response formatlarÄ±nÄ± standardize etmek</li>
                <li>Logging sistemini daha profesyonel hale getirmek</li>
            </ul>
        </div>

        <div class="warning">
            <strong>ğŸ’¡ Ã–nemli Not:</strong> Bu tÃ¼r hatalar geliÅŸtirme sÃ¼recinin doÄŸal bir parÃ§asÄ±dÄ±r. Ã–nemli olan hatayÄ± fark etmek, sistematik olarak analiz etmek ve gelecekte benzer hatalarÄ± Ã¶nleyecek alÄ±ÅŸkanlÄ±klar geliÅŸtirmektir.
        </div>

        <footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666;">
            <p>Bu rapor, Node.js arama fonksiyonu debug sÃ¼recini dokÃ¼mante etmek amacÄ±yla hazÄ±rlanmÄ±ÅŸtÄ±r.</p>
            <p><em>Tarih: <%= new Date().toLocaleDateString('tr-TR') %></em></p>
        </footer>
    </div>
</body>
</html>